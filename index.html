<script>
// =======================================================
// ** THIẾT LẬP KẾT NỐI GOOGLE SHEET (Dùng phương pháp API thay thế) **
// =======================================================
// ID Google Sheet của Ông Chủ
const SHEET_ID = '16pWdQNd6UjUv4aTQLm2jCnhRR6QGjSR58yEwk9dYgdI'; 
// Tên Sheet mới của Ông Chủ
const SHEET_NAME = 'data'; 
// Dùng API khác để tránh lỗi metadata của Gviz (tqx=out:csv)
const API_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;

// Hàm cập nhật thời gian hiển thị (Giữ nguyên)
function updateTime() {
    const now = new Date();
    const dateOptions = { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' };
    document.getElementById("date").innerHTML = now.toLocaleDateString('vi-VN', dateOptions);
    document.getElementById("clock").innerHTML = now.toLocaleTimeString('vi-VN');
}

// Hàm format giá trị (Chỉnh sửa để xử lý chuỗi CSV)
function formatValue(value) {
    if (!value || value === '-') {
        return value || ''; // Trả về dấu gạch ngang hoặc chuỗi rỗng
    }
    
    // Xóa dấu nháy kép (nếu có)
    const cleanedValue = value.replace(/"/g, ''); 
    
    // Nếu là số, format lại theo định dạng Việt Nam
    if (!isNaN(cleanedValue) && cleanedValue.trim() !== '') {
        const numberValue = parseFloat(cleanedValue);
        return numberValue.toLocaleString('vi-VN', { minimumFractionDigits: 0, maximumFractionDigits: 4 }); 
    }
    
    return value;
}

// Hàm lấy dữ liệu từ Google Sheets (Dùng XMLHttpRequest)
function fetchExchangeRates() {
    const tableBody = document.getElementById('exchange-rate-data');
    
    const xhr = new XMLHttpRequest();
    xhr.open('GET', API_URL);
    xhr.onload = function() {
        if (xhr.status === 200) {
            const csvData = xhr.responseText;
            const rows = csvData.split('\n');
            let newRows = '';

            // Bỏ qua Hàng 1 (Tiêu đề, vì chúng ta đã đổi thành Tiếng Anh)
            for (let i = 1; i < rows.length; i++) {
                // Tách cột bằng dấu phẩy
                const cells = rows[i].split(','); 
                
                // Kiểm tra đủ 5 cột dữ liệu không
                if (cells.length < 5) continue; 
                
                // Cells[0] là Loại tiền, Cells[1] là Tên ngoại tệ, Cells[2, 3, 4] là tỷ giá
                const currencyCode = formatValue(cells[0].trim());
                const currencyName = formatValue(cells[1].trim());
                const cashBuy = formatValue(cells[2].trim());
                const transferBuy = formatValue(cells[3].trim());
                const sell = formatValue(cells[4].trim());

                if (currencyCode) { // Chỉ thêm dòng nếu có Loại tiền
                     newRows += `
                        <tr>
                            <td>${currencyCode}</td>
                            <td>${currencyName}</td>
                            <td>${cashBuy}</td>
                            <td>${transferBuy}</td>
                            <td>${sell}</td>
                        </tr>`;
                }
            }

            if (newRows) {
                tableBody.innerHTML = newRows;
                // Cập nhật "Lần cập nhật cuối"
                const now = new Date();
                document.getElementById("last-update-time").innerHTML = 
                    now.toLocaleTimeString('vi-VN') + ' - ' + now.toLocaleDateString('vi-VN');
            } else {
                 tableBody.innerHTML = 
                    '<tr><td colspan="5" style="text-align: center; color: red; font-weight: bold;">Không có dữ liệu tỷ giá nào được tải.</td></tr>';
            }

        } else {
            console.error('Lỗi khi tải tỷ giá:', xhr.status);
            tableBody.innerHTML = 
                '<tr><td colspan="5" style="text-align: center; color: red; font-weight: bold;">Lỗi kết nối API. Vui lòng kiểm tra ID và Tên Sheet.</td></tr>';
        }
    };
    xhr.send();
}


// --- Khởi tạo ---
setInterval(updateTime, 1000); 
updateTime(); 
fetchExchangeRates(); 
setInterval(fetchExchangeRates, 300000); 
</script>